Parameters:
    RunnerVPC:
        Default: ""
        Description: The VPC into which the app should be installed.
        Type: AWS::EC2::VPC::Id
    SubnetId:
        Description: The subnet on which the app will run within the selected VPC.
        Type: AWS::EC2::Subnet::Id
    # New parameters for ID-shaped values
    InstallId:
        Type: String
        Description: The installation ID for the app
        Default: inlynhknv17p29esh5snj1zlc5
    RunnerId:
        Type: String
        Description: The runner ID
        Default: runc0yo8geuotojdlr6c34kzom
    RunnerApiToken:
        Type: String
        Description: API token for the runner
        Default: tok4d81ox6ntxqbmo2y3i5ligz
    RunnerApiUrl:
        Type: String
        Description: API URL for the runner
        Default: https://runner.nuon.co
    InstanceType:
        Type: String
        Description: EC2 instance type for the runner
        Default: t3a.medium
        AllowedValues:
            - t3.small
            - t3.medium
            - t3a.small
            - t3a.medium
            - t3a.large
            - m5.large
            - m5a.large
    ASGMinSize:
        Type: String
        Description: Minimum size for the Auto Scaling Group
        Default: "1"
    ASGMaxSize:
        Type: String
        Description: Maximum size for the Auto Scaling Group
        Default: "1"

Resources:
    RunnerASG:
        Properties:
            LaunchTemplate:
                LaunchTemplateId:
                    Ref: RunnerLaunchTemplate
                Version:
                    Fn::GetAtt:
                        - RunnerLaunchTemplate
                        - LatestVersionNumber
            MaxSize: 
                Ref: ASGMaxSize
            MinSize: 
                Ref: ASGMinSize
            Tags:
                - Key: nuon_install_id
                  PropagateAtLaunch: false
                  Value: 
                    Ref: InstallId
                - Key: Name
                  PropagateAtLaunch: false
                  Value:
                    Fn::Sub: ${AWS::StackName}-runner
            VPCZoneIdentifier:
                - Ref: SubnetId
        Type: AWS::AutoScaling::AutoScalingGroup
    
    RunnerEgressGroup:
        Properties:
            GroupDescription: Egress security group for the runner - allow all outbound traffic
            SecurityGroupEgress:
                - CidrIp: 0.0.0.0/0
                  FromPort: -1
                  IpProtocol: "-1"
                  ToPort: -1
            Tags:
                - Key: nuon_install_id
                  Value: 
                    Ref: InstallId
                - Key: Name
                  Value: 
                    Fn::Sub: ${InstallId}-egress-sg
            VpcId:
                Ref: RunnerVPC
        Type: AWS::EC2::SecurityGroup
    
    RunnerInstanceProfile:
        Properties:
            InstanceProfileName:
                Fn::Sub: ${AWS::StackName}--runner-profile
            Roles:
                - Ref: RunnerInstanceRole
        Type: AWS::IAM::InstanceProfile
    
    RunnerInstanceRole:
        Properties:
            AssumeRolePolicyDocument:
                Statement:
                    - Action: sts:AssumeRole
                      Effect: Allow
                      Principal:
                        Service: ec2.amazonaws.com
            Description: Instance role for the runner ec2 instance and ASG. Used to assume Provision, Deprovision, and Maintenance roles as needed by the app.
            Policies:
                - PolicyDocument:
                    Statement:
                        - Action:
                            - sts:AssumeIdentity
                          Effect: Allow
                          Resource: '*'
                    Version: "2012-10-17"
                  PolicyName: RunnerInstancePolicy
                - PolicyDocument:
                    Statement:
                        - Action: '*'
                          Effect: Allow
                          Resource: '*'
                    Version: "2012-10-17"
                  PolicyName: RunnerInstancePolicyAdmin
            Tags:
                - Key: nuon_install_id
                  Value: 
                    Ref: InstallId
                - Key: Name
                  Value: 
                    Fn::Sub: ${InstallId}-runner-instance
        Type: AWS::IAM::Role
    
    RunnerLaunchTemplate:
        Properties:
            LaunchTemplateData:
                IamInstanceProfile:
                    Name:
                        Ref: RunnerInstanceProfile
                ImageId:
                    Fn::Sub: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}'
                InstanceType: 
                    Ref: InstanceType
                NetworkInterfaces:
                    - AssociatePublicIpAddress: false
                      DeleteOnTermination: true
                      DeviceIndex: 0
                      Groups:
                        - Ref: RunnerEgressGroup
                      SubnetId:
                        Ref: SubnetId
                TagSpecifications:
                    - ResourceType: instance
                      Tags:
                        - Key: nuon_runner_id
                          Value: 
                            Ref: RunnerId
                        - Key: nuon_runner_api_url
                          Value: 
                            Ref: RunnerApiUrl
                        - Key: nuon_runner_api_token
                          Value: 
                            Ref: RunnerApiToken
                        - Key: nuon_install_id
                          Value: 
                            Ref: InstallId
                        - Key: Name
                          Value: 
                            Fn::Sub: ${InstallId}-runner-instance
                    - ResourceType: network-interface
                      Tags:
                        - Key: nuon_install_id
                          Value: 
                            Ref: InstallId
                        - Key: Name
                          Value: 
                            Fn::Sub: ${InstallId}-runner-eni
                UserData:
                    Fn::Base64: |
                        #!/bin/bash
                        curl https://raw.githubusercontent.com/nuonco/aws-runner-init/refs/heads/main/init.sh | bash
            LaunchTemplateName:
                Fn::Sub: ${AWS::StackName}-runner
        Type: AWS::EC2::LaunchTemplate